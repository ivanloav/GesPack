# Conversi√≥n de Tablas de SQL Server a PostgreSQL

Este documento describe el proceso de conversi√≥n de tablas de una base de datos en SQL Server a PostgreSQL. Aqu√≠ se detallan los pasos realizados, las diferencias clave entre ambos sistemas y las decisiones tomadas durante la migraci√≥n.

## √çndice
   - üèõÔ∏è **[Principios Generales de la Base de Datos](#principios-generales-de-la-base-de-datos)**
   - ‚úÖ [CheckList de verificaci√≥n para DB multi-tenant](docs/checklist-multitenant.md)
   - üîë [Inclusi√≥n del Campo `site_id`](#inclusi√≥n-del-campo-site_id)
   - üïµÔ∏è [Campos de Auditor√≠a](#campos-de-auditor√≠a)
   - üì¶ [Tablas Creadas o convertidas](#tablas-creadas-o-convertidas)
   - üí° [Funci√≥n de cada tabla](#-funci√≥n-de-cada-tabla)
   - üß© [Diagrama Entidad-Relaci√≥n GesPack (PNG)](#-diagrama-entidad-relaci√≥n-gespack-png)
   - ‚ùì [FAQ y buenas pr√°cticas](#faq-y-buenas-pr√°cticas)
   - üöÄ [Scripts de migraci√≥n y despliegue](#scripts-de-migraci√≥n-y-despliegue)
   - ‚ö†Ô∏è [Compatibilidad](#compatibilidad)
   - üõ†Ô∏è [Contacto y mantenimiento](#contacto-y-mantenimiento)
   - üìÑ [Licencia](#-licencia)

## üèõÔ∏è Principios Generales de la Base de Datos

### Inclusi√≥n del Campo `site_id`
- **¬øQu√© es `site_id`?**
  - El campo `site_id` identifica de forma √∫nica al cliente (sitio) al que pertenece cada registro. Es esencial en un entorno multi-cliente.
  
- **¬øPor qu√© es importante?**
  - Permite que varias empresas o clientes utilicen la misma base de datos sin conflictos, asegurando que todos los datos est√©n correctamente segregados.
  
- **¬øC√≥mo se utiliza?**
  - **Claves Primarias**: Todas las tablas principales utilizan `site_id` como parte de la clave primaria compuesta.
  - **Claves For√°neas**: Las relaciones entre tablas incluyen `site_id` para garantizar la coherencia y aislamiento de los datos.

### Campos de Auditor√≠a
- **¬øQu√© son estos campos?**
  - Todas las tablas incluyen los siguientes campos para rastrear la creaci√≥n y modificaci√≥n de los registros:
    - `created_by`: Nombre del usuario que realiz√≥ la inserci√≥n.
    - `created_at`: Fecha y hora de la inserci√≥n.
    - `modified_by`: Nombre del usuario que realiz√≥ la √∫ltima modificaci√≥n.
    - `modified_at`: Fecha y hora de la √∫ltima modificaci√≥n.

- **¬øPor qu√© son importantes?**
  - Ayudan a mantener un historial claro de qui√©n realiza cambios en los datos y cu√°ndo se realizan, facilitando la auditor√≠a y el mantenimiento.

- **¬øC√≥mo se utilizan?**
  - Los valores de `created_by` y `modified_by` se asignan desde la capa de la aplicaci√≥n o mediante triggers, seg√∫n el flujo de trabajo.
  - Los valores de `created_at` y `modified_at` se establecen autom√°ticamente con `CURRENT_TIMESTAMP` o por la l√≥gica de negocio.

---

Para informaci√≥n detallada de cada tabla, consulta los archivos espec√≠ficos en la carpeta `docs`.

### üì¶ Tablas Creadas o convertidas
   - [Sites (Clientes / Sites)](docs/sites.md)
   - [Users (Usuarios de la Aplicaci√≥n)](docs/users.md)
   - [User Sites (Asignaci√≥n de Usuarios a Sites)](docs/user_sites.md)
   - [Brands (Marcas)](docs/brands.md)
   - [Actions Categories (Categor√≠as de Acciones)](docs/action_categories.md)
   - [Actions Priority Types (Tipos de Prioridad de Acci√≥n)](docs/action_priority_types.md)
   - [Actions Category Costs (Costes por Categor√≠a de Acci√≥n)](docs/action_category_costs.md)
   - [Actions (Acciones)](docs/actions.md)
   - [Customers (Clientes)](docs/customers.md)
   - [Customers Marked Types (Tipos de Marcado de Clientes)](docs/customer_marked_types.md)
   - [Customers RNVP Types (Tipos RNVP de Clientes)](docs/customer_rnvp_types.md)
   - [Correspondence (Correspondencia)](docs/correspondence.md)
   - [Order Payments Card Types (Tipos de Tarjeta)](docs/order_payment_card_types.md)
   - [Order Payments (Pagos de Pedido: engloba pagos totales y pagos aplazados)](docs/order_payments.md)
   - [Order Payment Schedules (Plazos de Pago del Pedido)](docs/order_payment_schedules.md)
   - [Orders (Pedidos)](docs/orders.md)
   - [Order Addresses (Direcciones de Pedido)](docs/order_addresses.md)
   - [Order Notes (Notas de Pedido)](docs/order_notes.md)
   - [Order Items (L√≠neas de Pedido)](docs/order_items.md)
   - [Order Item Substitutes (Sustituciones de L√≠neas de Pedido)](docs/order_item_substitutes.md)
   - [Packaging (Tipos de Embalaje)](docs/packaging.md)
   - [Packaging Sites (Asignaci√≥n de Embalajes por Cliente)](docs/packaging_sites.md)
   - [Product Substitutes (Sustituciones de Producto)](docs/product_substitutes.md)
   - [Product Substitutes Log (Hist√≥rico Sustituciones)](docs/product_substitutes_log.md)
   - [Products (Productos)](docs/products.md)
   - [Product Bundles (Bundles de Productos)](docs/product_bundles.md)
   - [Returns (Devoluciones)](docs/returns.md)
   - [Return Items (L√≠neas de Devoluci√≥n)](docs/return_items.md)
   - [Invoicing (Facturaci√≥n)](docs/invoicing.md)
   - [Invoicing refunds (Facturaci√≥n Abonos)](docs/invoicing_refunds.md)
   - [Montant (Tramos de Importe)](docs/montant.md)
   - [Recency (Rangos de recencia)](docs/recency.md)
   - [Customer Participants (Participaciones de Clientes)](docs/customer_participants.md)
   - [Products Unavailable (Productos No Disponibles)](docs/product_unavailable.md)
   - [Products Unavailable Log (Hist√≥rico de Productos No Disponibles)](docs/product_unavailable_log.md)
   - [Stock Entries (Entradas de Stock)](docs/stock_entries.md)
   - [Error Log (Hist√≥rico de Errores)](docs/error_log.md)

---

### üí° Funci√≥n de cada tabla

| Tabla                                  | Funci√≥n / Explicaci√≥n breve                                                                     |
|----------------------------------------|-------------------------------------------------------------------------------------------------|
| Sites                                  | Identifica cada cliente o tenant en el sistema multiempresa.                                    |
| Users      | Guarda la informaci√≥n y permisos principales de cada usuario, permitiendo roles globales y gesti√≥n multi-site mediante la tabla intermedia `user_sites`. |
| User Sites | Relaciona usuarios con uno o varios sites (clientes/tenants), permitiendo controlar a qu√© empresas tiene acceso cada usuario de forma flexible.           || Brands                                 | Cat√°logo de marcas gestionadas por cada cliente.                                                |
| Actions Categories                     | Clasifica las acciones comerciales en categor√≠as o familias.                                    |
| Actions Priority Types                 | Define niveles de prioridad para las acciones o campa√±as.                                       |
| Actions Category Costs                 | Costes o tarifas asignados a cada categor√≠a de acci√≥n comercial.                                |
| Actions                                | Define campa√±as, promociones o acciones comerciales aplicables a pedidos y productos.           |
| Customers                              | Almacena los datos principales, fiscales y de contacto de los clientes.                         |
| Customers Marked Types                 | Clasificaci√≥n interna de clientes (VIP, bloqueado, etc.).                                       |
| Customers RNVP Types                   | Tipos de restricci√≥n para no contactar a clientes (Robinson, NPAI, etc.).                       |
| Correspondence                         | Historial de cartas, notificaciones y otras comunicaciones con el cliente.                      |
| Order Payments Card Types              | Cat√°logo de tipos de tarjetas admitidas en pagos.                                               |
| Order Payments                         | Guarda todos los pagos asociados a un pedido (efectivo, cheque, tarjeta, aplazado), permitiendo trazabilidad y control de impagos y fraccionamientos. |
| Order Payment Schedules                | Detalla cada uno de los plazos/fracciones de los pagos aplazados, con su importe, fecha y estado, vinculado a un pago principal.                   |
| Orders                                 | Cabecera de cada pedido; agrupa la informaci√≥n principal y referencias al cliente.              |
| Order Addresses                        | Direcciones de env√≠o y facturaci√≥n asociadas a cada pedido.                                     |
| Order Notes                            | Observaciones internas o externas relacionadas con un pedido.                                   |
| Order Items                            | L√≠neas de pedido: cada producto o servicio solicitado en un pedido.                             |
| Order Item Substitutes                 | L√≠neas de pedido que han sido sustituidas por otro producto.                                    |
| Packaging                              | Tipos y formatos de embalaje definidos y sus caracter√≠sticas.                                   |
| Packaging Sites                        | Asignaci√≥n y control de embalajes disponibles para cada cliente/site.                           |
| Product Substitutes                    | Reglas de sustituci√≥n autom√°tica entre productos y l√≥gica de stock.                             |
| Product Substitutes Log                | Hist√≥rico detallado de sustituciones efectivas realizadas.                                      |
| Products                               | Almac√©n completo de productos y todos sus atributos clave.                                      |
| Product Bundles                        | Productos agrupados en packs o lotes para venta conjunta.                                       |
| Returns                                | Cabecera de devoluciones de pedidos por parte del cliente.                                      |
| Return Items                           | Productos concretos devueltos dentro de una devoluci√≥n.                                         |
| Invoicing                              | Datos y estado de la facturaci√≥n de pedidos.                                                    |
| Invoicing refunds                      | Facturaci√≥n asociada a abonos o devoluciones.                                                   |
| Frequency                              | Frecuencia o periodicidad utilizada para acciones o informes.                                   |
| VAT yearly                             | Informaci√≥n y c√°lculos anuales del IVA para el site o cliente.                                  |
| Customers Marked Types                 | Tipos de marcado (flags) internos de cliente, ej: moroso, prioritario, etc.                     |
| Customers RNVP Types                   | Restricciones de contacto legal/reglamentaria seg√∫n RGPD, etc.                                  |
| Montant                                | Define rangos o tramos de importe por cliente (site), permitiendo gestionar tarifas escalonadas, l√≠mites o reglas de negocio basadas en cuant√≠as. |
| Recency | Define rangos de recencia o antig√ºedad por cliente/site, utilizados para segmentaci√≥n, reglas de negocio o campa√±as. |
| Customer Participants | Registra la participaci√≥n de clientes en campa√±as, promociones o eventos, relacionando el cliente por su `customer_id` y guardando tambi√©n el `customer_code` para b√∫squedas r√°pidas desde QR u otras integraciones. |
| Products Unavailable      | Almacena productos o referencias no disponibles temporalmente para un cliente/site, con control de cantidad y vigencia. |
| Products Unavailable Log  | Guarda el hist√≥rico de cada registro de producto no disponible en pedidos, con referencia, l√≠nea y cantidad, para auditor√≠a y trazabilidad. |
| Stock Entries | Registra todas las entradas y movimientos de stock por producto y cliente, vinculando cada registro con su producto y site para trazabilidad, control y auditor√≠a de inventario. |
| Error Log                        | Guarda todas las incidencias y errores producidos en la aplicaci√≥n, indicando gravedad, usuario, pedido y estado de resoluci√≥n, para facilitar la depuraci√≥n y soporte t√©cnico. |

---

## üß© Diagrama Entidad-Relaci√≥n GesPack (PNG)
üó∫Ô∏è [Diagrama ER completo](docs/ER-Diagram.png)  
_Este diagrama refleja la estructura l√≥gica de la base de datos GesPack, representando todas las tablas funcionales, auxiliares y de cat√°logo, as√≠ como sus relaciones (incluidas claves for√°neas compuestas multi-tenant por `site_id`). Es la referencia central para el an√°lisis de integridad referencial, trazabilidad de claves y dise√±o evolutivo del modelo de datos._

---

## ‚ùì FAQ y buenas pr√°cticas

### ¬øQu√© hacer si a√±ado una nueva tabla?
- A√±ade siempre el campo `site_id` como clave for√°nea si la tabla es multi-tenant.
- Usa nombres en ingl√©s y `snake_case` para todos los campos y tablas.
- A√±ade los campos de auditor√≠a: `created_by`, `created_at`, `modified_by`, `modified_at`.
- Actualiza el listado y la tabla de explicaci√≥n en este README.
- Crea el archivo `.md` de documentaci√≥n detallada en la carpeta `docs/`.

### ¬øC√≥mo nombro un campo nuevo?
- Utiliza siempre ingl√©s y formato `snake_case`.
- Si es FK, usa el mismo nombre que en la tabla referenciada.
- Prefiere nombres cortos y descriptivos: `order_id`, `customer_code`, `is_active`, etc.

---

## üöÄ Scripts de migraci√≥n y despliegue

- Encuentra el script principal aqu√≠:  
  [`Z-Deploy-PGAdmin.psql`](Z-Deploy-PGAdmin.psql)
- Otros scripts de migraci√≥n, actualizaci√≥n y utilidades est√°n en la carpeta [`scripts/`](scripts/).

---

## ‚ö†Ô∏è Compatibilidad

> **Este proyecto est√° validado para PostgreSQL 16.x**  
> Si usas otra versi√≥n, revisa las restricciones de tipos de dato, √≠ndices e instrucciones espec√≠ficas.  
> No garantizado el funcionamiento en versiones anteriores a 15.x.

---

## üõ†Ô∏è Contacto y mantenimiento

- **Responsable del modelo:** Iv√°n L√≥pez
- **Email soporte:** ilopez@parcelontime.es
- **Para sugerencias o incidencias:** abre un issue en el repositorio o contacta al responsable.

---

## üìÑ Licencia

Este proyecto y su documentaci√≥n son propiedad exclusiva de Parcel On Time S.R.L.
Queda prohibida la copia, reproducci√≥n o distribuci√≥n total o parcial sin el consentimiento expreso del titular.
¬© 2024 Iv√°n / Parcel On Time S.R.L. ‚Äì Todos los derechos reservados.
